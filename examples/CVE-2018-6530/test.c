#include <stdio.h>

int main(){
    char *requri = getenv("REQUEST_URI");
    char *query;
    /* goto failure if the urquri does not start with "?service=" */
    if((query = strchr(requri, "?")) == NULL || strncmp(query, "?service=", strlen("?service=")))
    {
        goto failure_condition;
    }
    /* Point the control type field pointer 9 bytes beyond the requri */ 
    char *controlType = query + strlen("?service=");

    char *filename;

    /* Create/open a shell script using the specified control type string */
    sprintf(filename, "%s/%s_%d.sh", "/var/run", controlType, getpid());
    int fn = fopen(filename, "a+");
    /* Write self-deleting command into the srcipt and execute it by "sh -c"*/
    if(fn)
    {
        fprintf(fn, "rm -f %s/%s_%d.sh", "/var/run", controlType, getpid());
        fclose(fn);
        sprintf(filename, "%s/%s_%d.sh", "/var/run", controlType, getpid());
        system(filename);
    }
    failure_condition:
        printf("failure");
}